<!-- version1.0 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deformability Analysis - Vaccine Builder</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Header Banner -->
    <div class="app-header">
        <div class="container">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <i class="fas fa-project-diagram header-icon"></i>
                    <div>
                        <h1 class="app-title mb-0">Deformability Analysis</h1>
                        <p class="app-subtitle mb-0">Conformational Change Prediction</p>
                    </div>
                </div>
                <div>
                    <a href="/" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-home"></i> Home
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container main-container">
        
        <!-- Upload Section -->
        <div class="card main-card slide-up">
            <h3><i class="fas fa-upload"></i> Upload PDB Files</h3>
            <p class="text-muted">Upload reference (unbound) and target (complex) PDB structures</p>
            
            <form id="uploadForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            <i class="fas fa-file"></i> Reference PDB (Unbound Protein)
                            <span class="required">*</span>
                        </label>
                        <input type="file" class="form-control" id="referencePDB" accept=".pdb" required>
                        <small class="form-text">Upload the unbound protein structure</small>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            <i class="fas fa-file"></i> Target PDB (Protein in Complex)
                            <span class="required">*</span>
                        </label>
                        <input type="file" class="form-control" id="targetPDB" accept=".pdb" required>
                        <small class="form-text">Upload the complex structure</small>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            <i class="fas fa-link"></i> Reference Chain ID
                            <span class="required">*</span>
                        </label>
                        <input type="text" class="form-control" id="refChain" value="A" maxlength="1" required>
                        <small class="form-text">Chain ID of protein in reference structure (single letter)</small>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            <i class="fas fa-link"></i> Target Chain ID
                            <span class="required">*</span>
                        </label>
                        <input type="text" class="form-control" id="targetChain" value="B" maxlength="1" required>
                        <small class="form-text">Chain ID of protein in target structure (single letter)</small>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button type="submit" class="btn btn-primary btn-construct">
                        <i class="fas fa-upload"></i> Upload Files
                        <span class="btn-glow"></span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Analysis Parameters Section (Hidden by default) -->
        <div class="card main-card slide-up" id="parametersSection" style="display: none;">
            <h3><i class="fas fa-sliders-h"></i> Analysis Parameters</h3>
            <p class="text-muted">Configure deformability analysis settings</p>
            
            <form id="analysisForm">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">
                            <i class="fas fa-wave-square"></i> Number of Modes
                        </label>
                        <input type="number" class="form-control" id="nModes" value="20" min="1" max="100">
                        <small class="form-text">Number of normal modes to calculate (default: 20)</small>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button type="submit" class="btn btn-success btn-construct" id="runAnalysisBtn">
                        <i class="fas fa-play-circle"></i> Run Deformability Analysis
                        <span class="btn-glow"></span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Results Section (Hidden by default) -->
        <div class="card main-card fade-in" id="resultsSection" style="display: none;">
            <h3><i class="fas fa-chart-area"></i> Analysis Results</h3>
            
            <div class="alert alert-success" id="successMessage" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <span id="successText">Analysis completed successfully!</span>
            </div>
            
            <div id="plotsContainer"></div>
            
            <div class="text-center mt-4">
                <a href="#" class="btn btn-download" id="downloadZipBtn">
                    <i class="fas fa-download"></i> Download All Results (ZIP)
                </a>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="app-footer">
        <div class="container text-center">
            <p>&copy; 2025 Automated Multi Epitope Vaccine Builder. Powered by ProDy.</p>
        </div>
    </footer>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <i class="fas fa-project-diagram spinner-icon"></i>
            </div>
            <h3 class="loading-title">Running Deformability Analysis</h3>
            <p class="loading-text" id="loadingText">Analyzing conformational changes...</p>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let uploadedFiles = {
            ref_path: '',
            target_path: ''
        };

        // Upload form handler
        $('#uploadForm').on('submit', function(e) {
            e.preventDefault();
            
            const refFile = $('#referencePDB')[0].files[0];
            const targetFile = $('#targetPDB')[0].files[0];
            
            if (!refFile || !targetFile) {
                return;
            }
            
            const formData = new FormData();
            formData.append('reference_pdb', refFile);
            formData.append('target_pdb', targetFile);
            
            $('#loadingOverlay').addClass('show');
            
            $.ajax({
                url: '/upload_deformability_pdbs',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    $('#loadingOverlay').removeClass('show');
                    
                    console.log('Upload response:', response);
                    
                    if (response.success) {
                        uploadedFiles.ref_path = response.ref_path;
                        uploadedFiles.target_path = response.target_path;
                        
                        // Show parameters section
                        $('#parametersSection').slideDown();
                        
                        // Scroll to parameters section
                        $('html, body').animate({
                            scrollTop: $('#parametersSection').offset().top - 100
                        }, 500);
                    } else {
                        console.error('Upload error:', response.error);
                    }
                },
                error: function(xhr, status, error) {
                    $('#loadingOverlay').removeClass('show');
                    console.error('Upload AJAX error:', error, xhr.responseText);
                }
            });
        });

        // Analysis form handler
        $('#analysisForm').on('submit', function(e) {
            e.preventDefault();
            
            const refChain = $('#refChain').val().trim().toUpperCase();
            const targetChain = $('#targetChain').val().trim().toUpperCase();
            const nModes = $('#nModes').val();
            
            if (!refChain || refChain.length !== 1 || !targetChain || targetChain.length !== 1) {
                return;
            }
            
            $('#loadingOverlay').addClass('show');
            $('#runAnalysisBtn').prop('disabled', true);
            
            $.ajax({
                url: '/run_deformability_analysis',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    ref_path: uploadedFiles.ref_path,
                    target_path: uploadedFiles.target_path,
                    ref_chain: refChain,
                    target_chain: targetChain,
                    n_modes: parseInt(nModes)
                }),
                success: function(response) {
                    $('#loadingOverlay').removeClass('show');
                    $('#runAnalysisBtn').prop('disabled', false);
                    
                    console.log('Analysis response:', response);
                    
                    if (response.success) {
                        // Display plots
                        displayPlots(response.plots);
                        
                        // Show results section
                        $('#resultsSection').slideDown();
                        
                        // Scroll to results
                        $('html, body').animate({
                            scrollTop: $('#resultsSection').offset().top - 100
                        }, 500);
                    } else {
                        console.error('Analysis error:', response.error);
                        console.log('Output:', response.output);
                        console.log('Error output:', response.error_output);
                    }
                },
                error: function(xhr, status, error) {
                    $('#loadingOverlay').removeClass('show');
                    $('#runAnalysisBtn').prop('disabled', false);
                    console.error('Analysis AJAX error:', error, xhr.responseText);
                }
            });
        });

        function displayPlots(plots) {
            const container = $('#plotsContainer');
            container.empty();
            
            if (plots && plots.length > 0) {
                plots.forEach(function(plotName) {
                    const plotCard = `
                        <div class="plot-container mb-4">
                            <h5><i class="fas fa-chart-line"></i> ${formatPlotName(plotName)}</h5>
                            <img src="/download_deformability/${plotName}" 
                                 class="img-fluid rounded shadow-sm" 
                                 alt="${plotName}">
                            <div class="mt-2">
                                <a href="/download_deformability/${plotName}" 
                                   class="btn btn-sm btn-outline-primary" 
                                   download="${plotName}">
                                    <i class="fas fa-download"></i> Download
                                </a>
                            </div>
                        </div>
                    `;
                    container.append(plotCard);
                });
            } else {
                container.html('<p class="text-muted">No plots generated</p>');
            }
        }

        function formatPlotName(filename) {
            // Convert filename to readable format
            return filename.replace(/_/g, ' ').replace('.png', '').replace(/\b\w/g, l => l.toUpperCase());
        }

        // Download ZIP handler
        $('#downloadZipBtn').on('click', function(e) {
            e.preventDefault();
            window.location.href = '/download_deformability_zip';
        });
    </script>
</body>
</html>
